services:
  airflow:
    build:
      dockerfile: tests/resources/airflow/Dockerfile
      # NOTE The path can be absolute or relative.
      # If it is relative, it is resolved from the Compose file's parent folder.
      context: ./../../../
    platform: linux/amd64
    image: opendbt_airflow
    pull_policy: never
    container_name: airflow
    command: >
      bash -c "airflow db init &&
              airflow variables set dbt_docs_projects '{\"dbtcore\":\"/opt/dbtcore/target\",\"dbtfinance\":\"/opt/dbtfinance/target\"}' &&
              airflow standalone"
    ports: 
      - "8080:8080"
    volumes:
      # NOTE The path can be absolute or relative.
      - ./airflow/webserver_config.py:/opt/airflow/webserver_config.py
      - ./airflow/airflow.cfg:/opt/airflow/airflow.cfg
      - ./dags:/opt/airflow/dags:rw
      - ./plugins:/opt/airflow/plugins:rw
      - ./../dbtcore:/opt/dbtcore:rw
      - ./../dbtfinance:/opt/dbtfinance:rw
      - ./../../../opendbt/macros:/opt/dbtcore/macros:rw
    environment:
      - AIRFLOW__WEBSERVER__INSTANCE_NAME=LOCAL
      - AIRFLOW_ENVIRONMENT=LOCAL
      - AIRFLOW_PLUGIN_MODE=${AIRFLOW_PLUGIN_MODE:-single}
    networks: [airflow]

networks:
  airflow:
    driver: bridge