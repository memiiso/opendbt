<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>DBT Documentation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/sql.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css"/>
    <link href="https://unpkg.com/@tailwindcss/typography@0.4.x/dist/typography.min.css" rel="stylesheet"/>
    <style>
        /* Base styles */
        .model-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .code-block {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f8f8f8;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        .tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }

        /* Transitions */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        .sql-toggle {
            transition: all 0.3s ease;
        }

        .sql-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sql-toggle.expanded .sql-content {
            max-height: 1000px;
        }

        /* Search highlight */
        .search-highlight {
            background-color: #FEF08A;
            font-weight: bold;
        }

        /* Tree navigation */
        .tree-item {
            position: relative;
            padding-left: 1.25rem;
        }

        .tree-item:before {
            content: "";
            position: absolute;
            left: 0.5rem;
            top: 1.25rem;
            height: calc(100% - 1.25rem);
            border-left: 1px solid #d1d5db;
        }

        .tree-item:last-child:before {
            display: none;
        }

        .tree-toggle {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .tree-toggle:after {
            content: "+";
            font-size: 0.75rem;
            color: #6b7280;
        }

        .tree-toggle.expanded:after {
            content: "-";
        }

        .tree-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tree-content.collapsed {
            max-height: 0;
        }

        /* Sidebar links */
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 4px;
            color: #4B5563;
            text-decoration: none;
            font-size: 14px;
        }

        .sidebar-link:hover {
            background-color: #E5E7EB;
        }

        .sidebar-link.active {
            background-color: #DBEAFE;
            color: #1E40AF;
        }

        /* Materialized tags */
        .materialized-tag {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            margin-left: auto;
        }

        .materialized-view {
            background-color: #E0F2FE;
            color: #0369A1;
        }

        .materialized-table {
            background-color: #DCFCE7;
            color: #166534;
        }

        .materialized-source {
            background-color: #F3E8FF;
            color: #7E22CE;
        }

        .materialized-executesql {
            background-color: #FEF3C7;
            color: #92400E;
        }

        /* Dependency links */
        .dependency-link {
            display: block;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            color: #4B5563;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .dependency-link:hover {
            background-color: #E5E7EB;
        }

        .dependency-link.model {
            border-left: 3px solid #3B82F6;
        }

        .dependency-link.source {
            border-left: 3px solid #10B981;
        }

        .dependency-link.macro {
            border-left: 3px solid #8B5CF6;
        }

        /* Lineage styles */
        .lineage-container {
            position: relative;
            overflow: scroll;
            width: 100%;
            min-height: 600px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            background-color: #f9fafb;
            display: flex; /* Added for centering SVG */
            justify-content: center; /* Added for centering SVG */
            align-items: center; /* Added for centering SVG */
        }

        .lineage-tabs {
            display: flex;
            border-bottom: 1px solid #E5E7EB;
            margin-bottom: 16px;
        }

        .lineage-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-right: 8px;
        }

        .lineage-tab.active {
            border-bottom-color: #3B82F6;
            color: #3B82F6;
            font-weight: 500;
        }

        /* Lineage Depth Controls */
        .lineage-depth-control {
            padding: 4px 10px;
            margin-left: 8px;
            border-radius: 9999px; /* pill shape */
            font-size: 12px;
            cursor: pointer;
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            transition: background-color 0.2s, color 0.2s;
        }

        .lineage-depth-control:hover {
            background-color: #d1d5db; /* gray-300 */
        }

        .lineage-depth-control.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 500;
        }

        /* Tab styles */
        .tab-button {
            padding: 0.5rem 1rem;
            margin-right: 0.25rem;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 0.375rem 0.375rem 0 0;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6B7280;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background-color: #F3F4F6;
            color: #1F2937;
        }

        .tab-button.active {
            background-color: white;
            border-color: #E5E7EB;
            color: #3B82F6;
        }

        .tab-content {
            padding: 1.5rem;
            border: 1px solid #E5E7EB;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            background-color: white;
        }

        /* Lineage Fullscreen Styles */
        .fullscreen-lineage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw; /* Use viewport width */
            height: 100vh; /* Use viewport height */
            z-index: 100; /* Ensure it's above other content */
            background-color: #f9fafb; /* Match original background */
            border: none; /* Remove border in fullscreen */
            border-radius: 0; /* Remove border-radius in fullscreen */
            min-height: 100vh; /* Ensure min-height covers viewport */
            overflow: hidden; /* Prevent scrolling of the body */
        }

        /* Ensure the graph container inside also fills the space */
        .fullscreen-lineage #lineageGraphContainer {
            width: 100%;
            height: 100%;
        }

        /* Container for the icon and tooltip */
        .icon-tooltip {
            position: relative; /* Needed for absolute positioning of the tooltip */
            display: inline-block; /* Or block, depending on your layout */
            cursor: default; /* Optional: Change cursor on hover */
        }

        /* Tooltip bubble */
        .icon-tooltip::before {
            content: attr(data-tooltip); /* Get text from data-tooltip attribute */
            position: absolute;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%); /* Center the tooltip */
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #333; /* Tooltip background */
            color: #fff; /* Tooltip text color */
            font-size: 1.1em;
            white-space: pre-line;
            opacity: 0; /* Hidden by default */
            visibility: hidden; /* Hidden by default */
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out; /* Smooth transition */
            z-index: 10; /* Ensure tooltip is above other elements */
            min-width: 550px;
        }

        /* Optional: Tooltip arrow */
        .icon-tooltip::after {
            content: '';
            position: absolute;
            bottom: 125%; /* Position below the bubble */
            left: 50%;
            transform: translateX(-50%) translateY(100%); /* Position arrow correctly */
            margin-bottom: -5px; /* Overlap slightly with the bubble */
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent; /* Arrow pointing down */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            z-index: 10;
        }

        /* Show tooltip on hover */
        .icon-tooltip:hover::before,
        .icon-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Style the icon itself if needed */
        .icon-tooltip i {
            font-size: 1.2em;
            color: #555;
        }

        .prose {
            max-width: inherit;
        }
    </style>
</head>
<body class="bg-gray-50">
<div id="app">
    <!-- Loading overlay -->
    <div class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50" v-if="isLoading">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-700">Loading DBT documentation...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-full mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center space-x-4 mr-4">
                <div class="flex items-center">
                    <i class="fas fa-database text-blue-500 text-2xl mr-2"></i>
                    <h1 class="text-xl font-bold text-gray-900">
                        {{ ODBTM.metadata?.project_name ?? 'DBT' }} Doc
                    </h1>
                </div>
            </div>
            <!-- Search Input Container -->
            <div class="relative flex-grow">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <input
                        :disabled="isLoading"
                        @input="performSearch"
                        class="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="Search models, columns..."
                        type="text"
                        v-model="searchQuery"
                >
                <!-- Clear Search Icon -->
                <div @click="clearSearch" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer"
                     v-if="searchQuery">
                    <i class="fas fa-times-circle text-gray-400 hover:text-gray-600"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col md:flex-row">
            <!-- Sidebar -->
            <div class="w-full md:w-96 flex-shrink-0 pr-0 md:pr-4 mb-6 md:mb-0">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">
                            {{ ODBTM.metadata?.project_name ?? 'Project Navigation' }}
                        </h2>
                    </div>
                    <div class="p-2 overflow-y-auto overflow-x-auto max-h-[calc(100vh-10rem)]">
                        <!-- Database Tree -->
                        <div :key="database.name" class="tree-item" v-for="database in databaseTree">
                            <div :class="{ 'expanded': expandedNodes.includes(database.name) }"
                                 @click="toggleNode(database.name)"
                                 class="flex items-center">
                                <div class="tree-toggle"></div>
                                <i class="fa-sharp-duotone fa-solid fa-server mr-2"></i>
                                <span class="font-medium">{{ database.name }}</span>
                            </div>
                            <div :class="expandedNodes.includes(database.name) ? 'expanded' : 'collapsed'"
                                 class="tree-content">
                                <!-- Schemas -->
                                <div :key="schema.name" class="tree-item" v-for="schema in database.schemas">
                                    <div :class="{ 'expanded': expandedNodes.includes(`${database.name}.${schema.name}`) }"
                                         @click="toggleNode(`${database.name}.${schema.name}`)"
                                         class="flex items-center">
                                        <div class="tree-toggle"></div>
                                        <i class="fas fa-folder text-yellow-500 mr-2"></i>
                                        <span class="font-medium">{{ schema.name }}</span>
                                    </div>
                                    <div :class="expandedNodes.includes(`${database.name}.${schema.name}`) ? 'expanded' : 'collapsed'"
                                         class="tree-content">
                                        <!-- Models -->
                                        <div class="tree-item" v-if="schema.models.length > 0">
                                            <div :class="{ 'expanded': expandedNodes.includes(`${database.name}.${schema.name}.models`) }"
                                                 @click="toggleNode(`${database.name}.${schema.name}.models`)"
                                                 class="flex items-center">
                                                <div class="tree-toggle"></div>
                                                <i class="fas fa-database text-blue-400 mr-2"></i>
                                                <span class="font-medium">Models</span>
                                            </div>
                                            <div :class="expandedNodes.includes(`${database.name}.${schema.name}.models`) ? 'expanded' : 'collapsed'"
                                                 class="tree-content">
                                                <a :class="{
                                               'sidebar-link active': selectedItem?.unique_id === model.unique_id,
                                               'sidebar-link': true
                                           }"
                                                   :key="model.unique_id"
                                                   @click.prevent="selectItem(model)"
                                                   href="#"
                                                   v-for="model in schema.models">
                                                    <i class="fa-solid fa-triangle-exclamation mr-2"
                                                       style="color: #ff2600;"
                                                       v-if="model?.run_status === 'error'">
                                                    </i>
                                                    <i :class="getIconClassForResourceType(model?.resource_type, model?.language)"
                                                       class="mr-2"
                                                       v-else>
                                                    </i>
                                                    <span class="min-w-0 truncate mr-2">{{ model.name }}</span>
                                                </a>
                                            </div>
                                        </div>
                                        <!-- Sources -->
                                        <div class="tree-item" v-if="schema.sources.length > 0">
                                            <div :class="{ 'expanded': expandedNodes.includes(`${database.name}.${schema.name}.sources`) }"
                                                 @click="toggleNode(`${database.name}.${schema.name}.sources`)"
                                                 class="flex items-center">
                                                <div class="tree-toggle"></div>
                                                <i class="fas fa-database text-green-500 mr-2"></i>
                                                <span class="font-medium">Sources</span>
                                            </div>
                                            <div :class="expandedNodes.includes(`${database.name}.${schema.name}.sources`) ? 'expanded' : 'collapsed'"
                                                 class="tree-content">
                                                <a :class="{
                                               'sidebar-link active': selectedItem?.unique_id === source.unique_id,
                                               'sidebar-link': true
                                           }"
                                                   :key="source.unique_id"
                                                   @click.prevent="selectItem(source)"
                                                   href="#"
                                                   v-for="source in schema.sources">
                                                    <i class="fa-solid fa-triangle-exclamation mr-2"
                                                       style="color: #ff2600;"
                                                       v-if="source?.run_status === 'fail'">
                                                    </i>
                                                    <i :class="getIconClassForResourceType(source?.resource_type, source?.language)"
                                                       v-else
                                                       class="mr-2"></i>
                                                    <span class="min-w-0 truncate mr-2">{{ source.name }}</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Panel -->
            <div class="flex-1">
                <transition name="fade">
                    <div class="mb-6" v-if="searchResults.length > 0 && searchQuery">
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="px-4 py-3 border-b border-gray-200">
                                <h2 class="text-lg font-medium text-gray-900">Search Results</h2>
                            </div>
                            <div class="divide-y divide-gray-200">
                                <div
                                        :key="result.path"
                                        @click="selectSearchResult(result)"
                                        class="px-4 py-3 hover:bg-gray-50 cursor-pointer"
                                        v-for="result in searchResults"
                                >
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="text-sm font-medium" v-html="highlightMatches(result.name)"></h3>
                                            <p class="text-xs text-gray-500 mt-1"
                                               v-html="highlightMatches(result.description ?? 'No description available')"></p>
                                        </div>
                                        <span :class="getIconClassForResourceType(result.resource_type, result.language)"
                                              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs">
                                        {{ result.resource_type }}
                                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>

                <div v-if="selectedItem">
                    <!-- Item Header -->
                    <div class="bg-white rounded-t-lg shadow px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">
                                    <span v-html="highlightMatches(selectedItem.database +'.'+ selectedItem.schema+'.'+selectedItem.name)"></span>
                                </h2>
                                <div class="mt-1 flex items-center space-x-2">
                                    <span :class="getIconClassForResourceType(selectedItem.resource_type, selectedItem.language)"
                                          class="inline-flex items-center py-0.5 rounded-full text-xs">
                                        {{ selectedItem.resource_type }}
                                    </span>
                                    <span class="text-xs text-gray-500" v-if="selectedItem.package_name && false">
                                        Project: {{ selectedItem.package_name }}
                                    </span>
                                    <span class="text-xs text-gray-500" v-if="selectedItem.config?.materialized"> <!-- Use ?. -->
                                        Materialized as: {{ selectedItem.config.materialized }}
                                    </span>
                                    <span class="text-xs text-gray-500" v-if="selectedItem.language">
                                        Language: {{ selectedItem.language }}
                                    </span>
                                    <!-- START: Run Result Fields -->
                                    <span class="text-xs text-gray-500" v-if="selectedItem.run_status">
                                        Run:
                                        <span :class="{
                                            'text-green-600 font-medium': ['success','pass'].includes(selectedItem.run_status),
                                            'text-red-600 font-medium': ['error','fail', 'runtime error'].includes(selectedItem.run_status),
                                            'text-yellow-600 font-medium': ['warn', 'partial success'].includes(selectedItem.run_status),
                                            'text-gray-600 font-medium': !['skipped'].includes(selectedItem.run_status)
                                        }">
                                            {{ selectedItem.run_status }}
                                        </span>
                                    </span>
                                    <span class="text-xs text-gray-500" v-if="selectedItem.run_completed_at">
                                        Completed At:{{ selectedItem.run_completed_at }}
                                    </span>
                                    <span :data-tooltip="selectedItem.run_message"
                                          class="text-xs text-gray-500 icon-tooltip"
                                          v-if="selectedItem.run_message">
                                         <i class="fa-duotone fa-solid fa-circle-info"></i> Message
                                    </span>
                                    <span class="text-xs text-red-600 font-bold" v-if="selectedItem.run_failures"> <!-- Failures are important -->
                                        Failures: {{ selectedItem.run_failures }}
                                    </span>
                                    <span :data-tooltip="JSON.stringify(selectedItem.run_adapter_response, null, 2)"
                                          class="text-xs text-gray-500 icon-tooltip"
                                          v-if="selectedItem.run_adapter_response && Object.keys(selectedItem.run_adapter_response).length > 0">
                                         <i class="fa-duotone fa-solid fa-circle-info"></i> Db Response
                                     </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="flex border-b border-gray-200 bg-gray-50 rounded-b-lg shadow mb-4">
                        <button
                                :class="['tab-button', { 'active': activeTab === 'overview' }]"
                                @click="activeTab = 'overview'"
                        >
                            Overview
                        </button>
                        <button
                                :class="['tab-button', { 'active': activeTab === 'columns' }]"
                                @click="activeTab = 'columns'"
                                v-if="displayColumns.length > 0"
                        >
                            Columns
                        </button>
                        <button
                                :class="['tab-button', { 'active': activeTab === 'code' }]"
                                @click="activeTab = 'code'"
                                v-if="getModelCode(selectedItem)"
                        >
                            {{ selectedItem.language === 'python' ? 'Python' : 'SQL' }}
                        </button>
                        <button
                                :class="['tab-button', { 'active': activeTab === 'dependencies' }]"
                                @click="activeTab = 'dependencies'"
                                v-if="selectedItem.depends_on || getDependents(selectedItem).length > 0"
                        >
                            Dependencies
                        </button>
                        <button
                                :class="['tab-button', { 'active': activeTab === 'metadata' }]"
                                @click="activeTab = 'metadata'"
                        >
                            Metadata
                        </button>
                        <button
                                :class="['tab-button', { 'active': activeTab === 'configuration' }]"
                                @click="activeTab = 'configuration'"
                                v-if="selectedItem && selectedItem.config">
                            Configuration
                        </button>
                        <button
                                :class="['tab-button', { 'active': activeTab === 'lineage' }]"
                                @click="activeTab = 'lineage'; renderTableLineageGraph()"
                        >
                            Lineage
                        </button>
                        <button
                                :class="['tab-button', { 'active': activeTab === 'ai' }]"
                                @click="activeTab = 'ai'"
                                v-if="selectedItem?.resource_type === 'model'"
                        >
                            AI Assistant
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="bg-white rounded-lg shadow overflow-hidden p-4">
                        <!-- Overview Tab -->
                        <div v-if="activeTab === 'overview'">
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Description</h3>
                            <div class="text-gray-700 prose lg:prose-sm"
                                 v-html="displayDescriptionText(selectedItem.description ?? 'No description available')"></div>
                            <!-- Use ?? -->
                        </div>

                        <!-- Columns Tab -->
                        <div v-if="activeTab === 'columns' && displayColumns.length > 0">
                            <h3 class="text-lg font-medium text-gray-900 mb-3">Columns</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            scope="col">
                                            Name
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            scope="col">
                                            Type
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            scope="col">
                                            Description
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            scope="col">
                                            DB Comment
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            scope="col">
                                            Transformation
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            scope="col">
                                            Depends On
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            scope="col">
                                            Tests
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                    <!-- Iterate over the new computed property -->
                                    <tr :key="column.name" class="hover:bg-gray-50"
                                        v-for="column in displayColumns">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            <!-- Use v-html carefully -->
                                            <span v-html="highlightMatches(column.name)"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <!-- Display data_type from computed property -->
                                            {{ column.type ?? 'N/A' }} <!-- Use ?? -->
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500 max-w-md">
                                            <!-- Added max-w-md for readability -->
                                            <!-- Display description from computed property -->
                                            <!-- Use v-html carefully -->
                                            <span v-html="highlightMatches(column.description ?? '')"></span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500 max-w-md">
                                            <!-- Display DB Comment -->
                                            <span v-html="highlightMatches(column.comment ?? '')"></span>
                                        </td>
                                        <td class="px-1 py-1 text-sm max-w-md">
                                            <!-- Display Columns Transformation -->
                                            <span class="text-gray-400"
                                                  v-if="!(Array.isArray(column.transformations) && column.transformations.length > 0)">
                                                N/A
                                            </span>
                                            <pre class="code-block w-full h-full !p-1 !text-xs !bg-gray-50 border overflow-x-auto"
                                                 v-else><code
                                                    v-html="highlightMatches(column.transformations.join('\n').trim())"></code></pre>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500 max-w-md whitespace-pre-line">
                                            <!-- Display Columns Depends On -->
                                            <span class="text-gray-400"
                                                  v-if="!(Array.isArray(column.depends_on) && column.depends_on.length > 0)">N/A</span>
                                            <a
                                                    :key="`ref-${cdep.column_fqn}`"
                                                    @click.prevent="navigateToDependencyId(cdep.model_id)"
                                                    class="dependency-link"
                                                    href="#"
                                                    v-for="cdep in column.depends_on"
                                            >
                                                <div class="flex items-center">
                                                    <i :class="getIconClassForResourceTypeById(cdep.model_id)"
                                                       class="mr-2"></i>
                                                    <span>{{ cdep.table_relative_fqn }}.<b>{{ cdep.name }}</b></span>
                                                </div>
                                            </a>

                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <!-- Display tests from computed property -->
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800"
                                                  v-if="column.data_tests?.length > 0"> <!-- Use ?. -->
                                                {{ column.data_tests }}
                                            </span>
                                            <span class="text-gray-400" v-else>No tests</span>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Code Tab -->
                        <div v-if="activeTab === 'code' && getModelCode(selectedItem)">
                            <h3 class="text-lg font-medium text-gray-900 mb-3">
                                {{ selectedItem.language === 'python' ? 'Python' : 'SQL' }} Definition
                            </h3>
                            <pre class="code-block mt-3"><code
                                    :class="selectedItem.language === 'python' ? 'language-python' : 'language-sql'">{{ getModelCode(selectedItem).trim()
                                }}</code></pre>
                        </div>

                        <!-- Dependencies Tab -->
                        <div v-if="activeTab === 'dependencies' && (selectedItem.depends_on || getDependents(selectedItem).length > 0)">
                            <h3 class="text-lg font-medium text-gray-900 mb-3">Dependencies</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Depends On -->
                                <div>
                                    <h4 class="text-md font-medium text-gray-700 mb-2">Depends On</h4>
                                    <div class="bg-gray-50 rounded-lg overflow-hidden">
                                        <div v-if="getDependencies(selectedItem).length > 0">
                                            <a
                                                    :class="`dependency-link.${dep.resource_type}`"
                                                    :key="`dep-${dep.resource_type}-${dep.name}`"
                                                    @click.prevent="navigateToDependency(dep)"
                                                    class="dependency-link"
                                                    href="#"
                                                    v-for="dep in getDependencies(selectedItem)"
                                            >
                                                <div class="flex items-center">
                                                    <i :class="getIconClassForResourceType(dep?.resource_type, dep?.language)"
                                                       class="mr-2"
                                                    ></i>
                                                    <span>{{ dep.name }}</span>
                                                </div>
                                            </a>
                                        </div>
                                        <div class="px-4 py-3 text-sm text-gray-500" v-else>
                                            No dependencies
                                        </div>
                                    </div>
                                </div>

                                <!-- Referenced By -->
                                <div>
                                    <h4 class="text-md font-medium text-gray-700 mb-2">Referenced By</h4>
                                    <div class="bg-gray-50 rounded-lg overflow-hidden">
                                        <div v-if="getDependents(selectedItem).length > 0">
                                            <a
                                                    :class="`dependency-link.${dep.resource_type}`"
                                                    :key="`ref-${dep.resource_type}-${dep.name}`"
                                                    @click.prevent="navigateToDependency(dep)"
                                                    class="dependency-link"
                                                    href="#"
                                                    v-for="dep in getDependents(selectedItem)"
                                            >
                                                <div class="flex items-center">
                                                    <i
                                                            :class="getIconClassForResourceType(dep?.resource_type, dep?.language)"
                                                            class="mr-2"
                                                    ></i>
                                                    <span>{{ dep.name }}</span>
                                                </div>
                                            </a>
                                        </div>
                                        <div class="px-4 py-3 text-sm text-gray-500" v-else>
                                            Not referenced by any objects
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata Tab -->
                        <div v-if="activeTab === 'metadata'">
                            <h3 class="text-lg font-medium text-gray-900 mb-3">Metadata</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gray-50 p-3 rounded" v-if="selectedItem.database">
                                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Database</h4>
                                    <p class="mt-1 text-sm text-gray-900">{{ selectedItem.database }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded" v-if="selectedItem.schema">
                                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Schema</h4>
                                    <p class="mt-1 text-sm text-gray-900">{{ selectedItem.schema }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded" v-if="selectedItem.package_name">
                                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Package</h4>
                                    <p class="mt-1 text-sm text-gray-900">{{ selectedItem.package_name }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded" v-if="selectedItem.original_file_path">
                                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">File
                                        Path</h4>
                                    <p class="mt-1 text-sm text-gray-900 break-words">{{ selectedItem.original_file_path
                                        }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded" v-if="selectedItem.unique_id">
                                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Unique
                                        ID</h4>
                                    <p class="mt-1 text-sm text-gray-900 break-words">{{ selectedItem.unique_id }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded" v-if="selectedItem.created_at">
                                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Created
                                        At</h4>
                                    <p class="mt-1 text-sm text-gray-900">
                                        {{ new Date(selectedItem.created_at * 1000).toLocaleString() }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded">
                                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</h4>
                                    <p class="mt-1 text-sm text-gray-900">{{ selectedItem.tags }}</p>
                                </div>
                            </div>

                            <!-- Statistics Section -->
                            <div class="mt-6" v-if="selectedItemStats && Object.keys(selectedItemStats).length > 0">
                                <h3 class="text-lg font-medium text-gray-900 mb-3">Statistics</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div :key="stat.id" class="bg-gray-50 p-3 rounded"
                                         v-for="stat in selectedItemStats">
                                        <h4 :title="stat.description"
                                            class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {{ stat.label }}</h4>
                                        <p class="mt-1 text-sm text-gray-900">{{ stat.value }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 text-sm text-gray-500" v-else>
                                No statistics available for this item.
                            </div>
                        </div>

                        <!-- Configuration Tab -->
                        <div v-if="activeTab === 'configuration' && selectedItem && selectedItem.config">
                            <h3 class="text-lg font-medium text-gray-900 mb-3">Configuration</h3>
                            <pre class="code-block mt-3"><code
                                    class="language-json">{{ JSON.stringify(selectedItem.config, null, 2)
                                }}</code></pre>
                        </div>

                        <!-- Lineage Tab -->
                        <div v-if="activeTab === 'lineage'">
                            <div>
                                <div class="flex justify-between items-center float-right mb-3">
                                    <!-- START: Lineage Depth Controls -->
                                    <div class="flex items-center mr-4"> <!-- Added mr-4 for spacing -->
                                        <span class="text-sm text-gray-600 mr-2">Depth:</span>
                                        <button
                                                :class="['lineage-depth-control', { 'active': lineageMaxDepth === 1 }]"
                                                @click="setLineageDepth(1)">
                                            1
                                        </button>
                                        <button
                                                :class="['lineage-depth-control', { 'active': lineageMaxDepth === 2 }]"
                                                @click="setLineageDepth(2)">
                                            2
                                        </button>
                                        <button
                                                :class="['lineage-depth-control', { 'active': lineageMaxDepth === 3 }]"
                                                @click="setLineageDepth(3)">
                                            3
                                        </button>
                                        <button
                                                :class="['lineage-depth-control', { 'active': lineageMaxDepth === Infinity }]"
                                                @click="setLineageDepth(Infinity)">
                                            All
                                        </button>
                                    </div>
                                    <!-- END: Lineage Depth Controls -->

                                    <!-- START: Full Screen Button -->
                                    <button
                                            @click="toggleLineageFullScreen"
                                            class="p-2 rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
                                            title="Toggle Fullscreen"
                                    >
                                        <i :class="isLineageFullScreen ? 'fas fa-compress' : 'fas fa-expand'"></i>
                                    </button>
                                    <!-- END: Full Screen Button -->
                                </div>
                            </div>

                            <!-- Apply conditional class for fullscreen -->
                            <div :class="{ 'fullscreen-lineage': isLineageFullScreen }"
                                 class="lineage-container relative"
                                 ref="lineageContainer">
                                <div class="absolute top-0 left-0 w-full h-full" id="lineageGraphContainer"
                                     ref="lineageGraphContainer"></div>
                                <!-- SVG will be rendered here by Viz.js -->
                                <div class="text-center" v-if="lineageRendering">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                                    <p class="text-gray-600 text-sm">Rendering lineage graph...</p>
                                </div>
                        <div class="text-center text-red-600" v-if="!lineageRendering && lineageError">
                            <i class="fas fa-exclamation-triangle mr-2"></i> Error rendering lineage graph.
                        </div>
                    </div>
                </div>
                        <!-- AI Assistant Tab -->
                        <div v-if="activeTab === 'ai' && selectedItem?.resource_type === 'model'">
                            <div class="space-y-4">
                                <div class="bg-blue-50 border border-blue-200 text-blue-900 text-sm rounded-md p-4">
                                    <p class="font-semibold text-sm mb-1">Assistente de IA para {{ selectedItem.name }}</p>
                                    <p>Informe sua <code>OPENAI_KEY</code> (armazenada apenas no seu navegador) e descreva o que deseja, por exemplo: "melhore a documentação atual" ou "crie unit tests".</p>
                                </div>
                                <div class="grid gap-2">
                                    <label class="text-xs font-medium uppercase text-gray-500" for="ai-api-key">OPENAI API Key</label>
                                    <input
                                            class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            id="ai-api-key"
                                            placeholder="sk-..."
                                            type="password"
                                            v-model="aiApiKey">
                                    <p class="text-xs text-gray-500">Guarde apenas uma chave com permissões restritas. O valor fica salvo no <em>localStorage</em>.</p>
                                </div>
                                <div class="grid gap-4 md:grid-cols-2">
                                    <div class="flex flex-col gap-2">
                                        <label class="text-xs font-medium uppercase text-gray-500" for="ai-model">Modelo</label>
                                        <select
                                                class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                id="ai-model"
                                                v-model="aiModel">
                                            <option value="gpt-4o-mini">gpt-4o-mini</option>
                                            <option value="gpt-4o">gpt-4o</option>
                                            <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                                        </select>
                                    </div>
                                    <div class="flex items-end justify-end">
                                        <button
                                                class="px-3 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-md hover:bg-gray-100"
                                                type="button"
                                                @click="resetAiSession"
                                                :disabled="!activeAiSession || (!activeAiSession.messages.length && !activeAiSession.draft)">
                                            Limpar conversa
                                        </button>
                                    </div>
                                </div>
                                <div
                                        class="border border-gray-200 rounded-md bg-gray-50 max-h-80 overflow-y-auto space-y-3 p-3"
                                        v-if="activeAiSession && activeAiSession.messages.length">
                                    <div
                                            :class="message.role === 'assistant' ? 'bg-white border border-blue-100' : 'bg-blue-50 border border-blue-200'"
                                            class="rounded-md p-3 shadow-sm"
                                            v-for="(message, index) in activeAiSession.messages"
                                            :key="index">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs font-semibold uppercase text-gray-500">
                                                {{ message.role === 'assistant' ? 'Assistente' : 'Você' }}
                                            </span>
                                            <span class="text-[10px] text-gray-400">{{ new Date(message.timestamp).toLocaleString() }}</span>
                                        </div>
                                        <div class="prose prose-sm max-w-none text-gray-800"
                                             v-html="displayDescriptionText(message.content)"></div>
                                    </div>
                                </div>
                                <div
                                        class="text-sm text-red-600 bg-red-50 border border-red-200 rounded-md p-2"
                                        v-if="activeAiSession?.error">
                                    {{ activeAiSession.error }}
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium uppercase text-gray-500" for="ai-prompt">Solicitação</label>
                                    <textarea
                                            :disabled="activeAiSession?.isLoading"
                                            :placeholder="aiHasKey ? 'Descreva o que deseja que a IA faça...' : 'Informe sua OPENAI_KEY antes de enviar.'"
                                            class="w-full border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm p-3 resize-y"
                                            id="ai-prompt"
                                            rows="4"
                                            v-model="aiDraft"></textarea>
                                    <p class="text-xs text-gray-500">Sugestões: "Melhore a documentação atual", "Crie testes unitários", "Sugira consultas de validação".</p>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-gray-500">
                                        A resposta usa o contexto do modelo atual, incluindo colunas e SQL compilado.
                                    </div>
                                    <button
                                            :disabled="!canSendAiPrompt"
                                            @click="sendAiPrompt"
                                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-60 disabled:cursor-not-allowed">
                                        <i :class="activeAiSession?.isLoading ? 'fas fa-spinner fa-spin mr-2' : 'fas fa-paper-plane mr-2'"></i>
                                        <span>{{ activeAiSession?.isLoading ? 'Enviando...' : 'Enviar' }}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="bg-white rounded-lg shadow overflow-hidden" v-else-if="!isLoading">
                    <div class="px-6 py-12 text-center">
                        <i class="fas fa-book-open text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Welcome to DBT Docs</h3>
                        <p class="max-w-2xl mx-auto">
                            Select an item from the sidebar to view its documentation, or use the search bar to find
                            specific models, sources, or macros.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="module">
    const {createApp, ref, reactive, computed, onMounted, onUnmounted, nextTick, watch} = Vue;

    // --- HELPERS -- //

    /**
     * Recursively merges properties from source to target, enriching the target.
     * A value in the target is updated only if it is undefined, null, or an empty string.
     * If both target and source properties are objects, it merges them recursively.
     * @param {object} target The object to be merged into.
     * @param {object} source The object to merge from.
     * @returns {object} The merged object (target).
     */
    function deepMerge(target, source) {
        if (!target || typeof target !== 'object' || !source || typeof source !== 'object') {
            return target;
        }
        const isObject = (obj) => obj && typeof obj === 'object' && !Array.isArray(obj);

        for (const key in source) {
            if (Object.prototype.hasOwnProperty.call(source, key)) {
                const sourceVal = source[key];
                const targetVal = target[key];

                if (isObject(targetVal) && isObject(sourceVal)) {
                    deepMerge(targetVal, sourceVal);
                } else if (targetVal === undefined || targetVal === null || targetVal === '') {
                    target[key] = sourceVal;
                }
            }
        }
        return target;
    }

    /**
     * Combines nodes and sources from manifest, catalog, and run results into a single object.
     * @param {object} dbtManifestData - The content of manifest.json.
     * @param {object} dbtCatalogData - The content of catalog.json.
     * @param {object} dbtRunInfoJson - The content of run_results.json.
     * @returns {object} A unified map of all dbt nodes.
     */
    function getAllDbtNodes(dbtManifestData, dbtCatalogData, dbtRunInfoJson) {
        const allNodes = {};
        if (!dbtManifestData) {
            console.warn("getAllDbtNodes called with no manifest data.");
            return allNodes;
        }

        const manifestNodes = {...dbtManifestData.nodes, ...dbtManifestData.sources};
        const catalogNodes = {...dbtCatalogData?.nodes, ...dbtCatalogData?.sources};

        for (const [nodeId, manifestNode] of Object.entries(manifestNodes)) {
            const catalogNode = catalogNodes[nodeId] ?? {};
            allNodes[nodeId] = deepMerge(JSON.parse(JSON.stringify(manifestNode)), catalogNode);
        }

        const runInfoData = dbtRunInfoJson ?? {};
        for (const [uniqueId, result] of Object.entries(runInfoData?.nodes || {})) {
            if (Object.prototype.hasOwnProperty.call(allNodes, uniqueId)) {
                deepMerge(allNodes[uniqueId], result);
            }
        }
        return allNodes;
    }

    /**
     * Fetches and processes all necessary dbt artifact files.
     * @returns {Promise<object>} A promise that resolves to the processed manifest object.
     */
    async function loadDbtFiles() {
        try {
            const [manifestResponse, catalogResponse, cataloglResponse, dbtRunInfoResponse] = await Promise.all([
                fetch('manifest.json'),
                fetch('catalog.json'),
                fetch('catalogl.json'),
                fetch('run_info.json')
            ]);

            if (!manifestResponse.ok) throw new Error(`Failed to load manifest.json: ${manifestResponse.statusText}`);
            const dbtManifestJson = await manifestResponse.json();

            let dbtCatalogJson = {};
            if (cataloglResponse.ok) {
                dbtCatalogJson = await cataloglResponse.json();
                console.log("Loading opendbt catalog, including lineage data `catalogl.json`.");
            } else if (catalogResponse.ok) {
                dbtCatalogJson = await catalogResponse.json();
            } else {
                console.warn(`Failed to load catalog.json: ${catalogResponse.statusText}. Catalog features might be unavailable.`);
            }

            let dbtRunInfoJson = {};
            if (dbtRunInfoResponse.ok) {
                dbtRunInfoJson = await dbtRunInfoResponse.json();
            } else {
                console.warn(`Failed to load run_results.json: ${dbtRunInfoResponse.statusText}. Some run results might be unavailable.`);
            }

            dbtManifestJson.allnodes = getAllDbtNodes(dbtManifestJson, dbtCatalogJson, dbtRunInfoJson);
            return dbtManifestJson;
        } catch (error) {
            console.error('Error loading DBT files:', error);
            return {}; // Return empty object on failure to prevent app crash
        }
    }


    // --- CONFIGURATION -- //

    if (window.marked) {
        window.marked.setOptions({gfm: true, breaks: true, pedantic: false, sanitize: false});
    } else {
        console.warn("Marked.js library not found. Markdown rendering will not work.");
    }

    const VIS_NETWORK_OPTIONS = {
        layout: {
            randomSeed: 42,
            hierarchical: {enabled: true, direction: 'LR', sortMethod: 'directed', levelSeparation: 300, nodeSpacing: 180}
        },
        nodes: {shape: 'box', margin: 10, font: {size: 12, face: 'sans-serif'}, borderWidth: 1},
        edges: {
            arrows: 'to',
            smooth: {enabled: true, type: 'cubicBezier', forceDirection: 'horizontal', roundness: 0.5},
            color: {color: '#848484', highlight: '#3b82f6', hover: '#d1d5db'}
        },
        physics: {
            enabled: true,
            solver: 'barnesHut',
            barnesHut: {gravitationalConstant: -10000, centralGravity: 0.15, springLength: 180, springConstant: 0.03, damping: 0.09, avoidOverlap: 0.3},
            stabilization: {enabled: true, iterations: 1000, fit: true}
        },
        interaction: {hover: true, tooltipDelay: 200, navigationButtons: true, keyboard: true, dragNodes: true, dragView: true},
        groups: {
            model: {color: {border: '#3B82F6', background: '#DBEAFE', highlight: {border: '#2563EB', background: '#BFDBFE'}}, font: {color: '#1E40AF'}},
            source: {color: {border: '#10B981', background: '#D1FAE5', highlight: {border: '#059669', background: '#A7F3D0'}}, font: {color: '#065F46'}},
            macro: {color: {border: '#8B5CF6', background: '#EDE9FE', highlight: {border: '#7C3AED', background: '#DDD6FE'}}, font: {color: '#5B21B6'}},
            column: {color: {border: '#9CA3AF', background: '#E5E7EB', highlight: {border: '#6B7280', background: '#F3F4F6'}}, font: {color: '#374151'}}
        }
    };

    // --- VUE APP -- //

    createApp({
        setup() {
            const isLoading = ref(true);
            const ODBTM = ref({});
            const activeTab = ref('overview');
            const expandedNodes = ref([]);
            const selectedItem = ref(null);
            const searchQuery = ref('');
            const searchResults = ref([]);
            const lineageGraphContainer = ref(null);
            const lineageContainer = ref(null);
            const lineageMaxDepth = ref(1);
            const lineageRendering = ref(false);
            const lineageError = ref(false);
            const isLineageFullScreen = ref(false);
            const aiModel = ref('gpt-4o-mini');
            const aiApiKey = ref('');
            const aiSessions = reactive({});
            let currentVisNetwork = null;

            const ensureAiSession = (itemId) => {
                if (!itemId) return null;
                if (!aiSessions[itemId]) {
                    aiSessions[itemId] = {
                        messages: [],
                        draft: '',
                        isLoading: false,
                        error: null
                    };
                }
                return aiSessions[itemId];
            };

            // --- COMPUTED PROPERTIES ---
            const databaseTree = computed(() => {
                if (!ODBTM.value.allnodes) return [];
                const databases = {};
                Object.values(ODBTM.value.allnodes).forEach(item => {
                    if (!['model', 'source', 'seed', 'snapshot', 'test'].includes(item.resource_type)) return;

                    const dbName = item?.database ?? '$database';
                    const schemaName = item?.schema ?? '$schema';

                    if (!databases[dbName]) databases[dbName] = {name: dbName, schemas: {}};
                    if (!databases[dbName].schemas[schemaName]) {
                        databases[dbName].schemas[schemaName] = {name: schemaName, models: [], sources: []};
                    }

                    if (['model', 'snapshot'].includes(item.resource_type)) {
                        databases[dbName].schemas[schemaName].models.push(item);
                    } else if (['source', 'seed', 'test'].includes(item.resource_type)) {
                        databases[dbName].schemas[schemaName].sources.push(item);
                    }
                });

                return Object.values(databases).map(db => ({
                    name: db.name,
                    schemas: Object.values(db.schemas).map(schema => ({
                        name: schema.name,
                        models: schema.models.sort((a, b) => a.name.localeCompare(b.name)),
                        sources: schema.sources.sort((a, b) => a.name.localeCompare(b.name))
                    })).sort((a, b) => a.name.localeCompare(b.name))
                })).sort((a, b) => a.name.localeCompare(b.name));
            });

            const allItems = computed(() => {
                if (!databaseTree.value) return [];
                return databaseTree.value.flatMap(db =>
                    db.schemas.flatMap(schema =>
                        [...schema.models, ...schema.sources].map(item => ({...item}))
                    )
                );
            });

            const allItemsById = computed(() => new Map(allItems.value.map(item => [item.unique_id, item])));
            const displayColumns = computed(() => Object.values(selectedItem.value?.columns ?? {}));
            const selectedItemStats = computed(() => Object.values(selectedItem.value?.stats ?? {}).filter(stat => stat.value));

            // --- METHODS ---
            const selectItem = (item, updateUrlHash = true) => {
                selectedItem.value = item;
                if (updateUrlHash) {
                    const newHash = `#${item.unique_id}`;
                    if (window.location.hash !== newHash) window.location.hash = newHash;
                }
                clearSearch();

                const dbName = item?.database ?? '$database';
                const schemaName = item?.schema ?? '$schema';
                if (!expandedNodes.value.includes(dbName)) expandedNodes.value.push(dbName);
                if (!expandedNodes.value.includes(`${dbName}.${schemaName}`)) expandedNodes.value.push(`${dbName}.${schemaName}`);
                const itemTypeGroup = ['model', 'snapshot'].includes(item.resource_type) ? 'models' : 'sources';
                if (!expandedNodes.value.includes(`${dbName}.${schemaName}.${itemTypeGroup}`)) {
                    expandedNodes.value.push(`${dbName}.${schemaName}.${itemTypeGroup}`);
                }

                ensureAiSession(item.unique_id);

                if (activeTab.value === 'lineage') renderTableLineageGraph();
                else if (['code', 'configuration'].includes(activeTab.value)) nextTick(() => hljs.highlightAll());

                document.querySelector('.flex-1')?.scrollTo({top: 0, behavior: 'smooth'});
            };

            const handleUrlHash = () => {
                const hash = window.location.hash.substring(1);
                if (hash && (!selectedItem.value || selectedItem.value.unique_id !== hash)) {
                    const itemFromHash = allItemsById.value.get(hash);
                    if (itemFromHash) selectItem(itemFromHash, false);
                    else console.warn(`Item with ID "${hash}" from URL hash not found.`);
                }
            };

            const toggleLineageFullScreen = async () => {
                if (!document.fullscreenElement) {
                    try {
                        await lineageContainer.value?.requestFullscreen();
                    } catch (err) {
                        console.error(`Error attempting full-screen: ${err.message}`);
                    }
                } else if (document.exitFullscreen) {
                    await document.exitFullscreen();
                }
            };

            const handleFullScreenChange = () => {
                isLineageFullScreen.value = !!document.fullscreenElement;
                nextTick(() => currentVisNetwork?.fit());
            };

            const activeAiSession = computed(() => {
                const item = selectedItem.value;
                if (!item) return null;
                return ensureAiSession(item.unique_id);
            });

            const aiDraft = computed({
                get() {
                    return activeAiSession.value?.draft ?? '';
                },
                set(value) {
                    const session = activeAiSession.value;
                    if (session) session.draft = value;
                }
            });

            const aiHasKey = computed(() => !!aiApiKey.value?.trim());

            const canSendAiPrompt = computed(() => {
                const session = activeAiSession.value;
                if (!session) return false;
                return aiHasKey.value && !!session.draft?.trim() && !session.isLoading;
            });

            const truncateText = (text, max = 4000) => {
                if (typeof text !== 'string') return '';
                return text.length > max ? `${text.slice(0, max)}\n...` : text;
            };

            const buildModelContext = (item) => {
                if (!item) return '';
                const lines = [
                    `Model name: ${item.name}`,
                    `Unique ID: ${item.unique_id}`,
                    `Resource type: ${item.resource_type}`,
                    `Database: ${item.database ?? 'n/a'}`,
                    `Schema: ${item.schema ?? 'n/a'}`
                ];
                if (item.description) {
                    lines.push(`Description: ${item.description}`);
                }
                const columns = Object.values(item.columns ?? {});
                if (columns.length) {
                    lines.push('Columns:');
                    columns.slice(0, 20).forEach(col => {
                        if (!col) return;
                        const pieces = [`- ${col.name}`];
                        if (col.description) {
                            pieces.push(`desc: ${col.description}`);
                        }
                        const depends = Array.isArray(col.depends_on)
                            ? col.depends_on
                                .map(dep => dep?.column ?? dep?.name)
                                .filter(Boolean)
                                .slice(0, 5)
                                .join(', ')
                            : '';
                        if (depends) {
                            pieces.push(`depends_on: ${depends}`);
                        }
                        lines.push(pieces.join(' | '));
                    });
                    if (columns.length > 20) {
                        lines.push(`(Total columns: ${columns.length}. Showing first 20.)`);
                    }
                }
                const materialization = item?.config?.materialized ?? item?.materialized;
                if (materialization) {
                    lines.push(`Materialization: ${materialization}`);
                }
                const tags = Array.isArray(item?.tags) ? item.tags.join(', ') : '';
                if (tags) {
                    lines.push(`Tags: ${tags}`);
                }
                const modelSql = item.compiled_code ?? item.raw_code;
                if (modelSql) {
                    lines.push('Model SQL:');
                    lines.push(truncateText(modelSql, 4000));
                }
                return lines.join('\n');
            };

            const sendAiPrompt = async () => {
                const item = selectedItem.value;
                if (!item) return;
                const session = ensureAiSession(item.unique_id);
                const trimmedKey = aiApiKey.value.trim();
                const prompt = session.draft?.trim();
                if (!trimmedKey) {
                    session.error = "Informe sua OPENAI_KEY para usar o assistente.";
                    return;
                }
                if (!prompt) {
                    session.error = "Escreva uma solicitação antes de enviar.";
                    return;
                }
                session.error = null;
                session.isLoading = true;
                const timestamp = new Date().toISOString();
                session.messages.push({
                    role: 'user',
                    content: prompt,
                    timestamp
                });
                session.draft = '';
                try {
                    const context = buildModelContext(item);
                    const payloadMessages = [
                        {
                            role: 'system',
                            content: [
                                "Você é um assistente técnico especializado em dbt e engenharia de dados.",
                                "Responda em português, com foco em orientação prática e exemplos concretos.",
                                "Use o contexto do modelo abaixo para personalizar a resposta.",
                                "",
                                "Contexto do modelo:",
                                context
                            ].join('\n')
                        },
                        ...session.messages.map(msg => ({
                            role: msg.role,
                            content: msg.content
                        }))
                    ];

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${trimmedKey}`
                        },
                        body: JSON.stringify({
                            model: aiModel.value,
                            temperature: 0.2,
                            messages: payloadMessages
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || `OpenAI API retornou status ${response.status}`);
                    }

                    const data = await response.json();
                    const assistantContent = data?.choices?.[0]?.message?.content?.trim();
                    if (!assistantContent) {
                        throw new Error('Resposta vazia recebida da OpenAI.');
                    }

                    session.messages.push({
                        role: 'assistant',
                        content: assistantContent,
                        timestamp: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('AI assistant error:', error);
                    session.error = error?.message ?? 'Erro ao consultar a API da OpenAI.';
                } finally {
                    session.isLoading = false;
                }
            };

            const resetAiSession = () => {
                const session = activeAiSession.value;
                if (!session) return;
                session.messages.splice(0);
                session.draft = '';
                session.error = null;
                session.isLoading = false;
            };

            const toggleNode = (nodePath) => {
                const index = expandedNodes.value.indexOf(nodePath);
                if (index === -1) expandedNodes.value.push(nodePath);
                else expandedNodes.value.splice(index, 1);
            };

            const getModelCode = (model) => model?.compiled_code ?? model?.raw_code ?? '';

            const displayDescriptionText = (text) => {
                if (typeof text !== 'string' || !text.trim()) return '';
                if (window.marked) {
                    try {
                        return window.marked.parse(text);
                    } catch (error) {
                        console.error('Error parsing Markdown:', error);
                        return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    }
                }
                return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            };

            const highlightMatches = (text) => {
                if (!searchQuery.value || !text) return text;
                const str = String(text);
                const regex = new RegExp(searchQuery.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                return str.replace(regex, (match) => `<span class="search-highlight">${match}</span>`);
            };

            const performSearch = () => {
                if (!searchQuery.value) {
                    searchResults.value = [];
                    return;
                }
                const query = searchQuery.value.toLowerCase();
                searchResults.value = allItems.value.filter(item =>
                    item.name.toLowerCase().includes(query) ||
                    item.description?.toLowerCase().includes(query) ||
                    (item.columns && Object.values(item.columns).some(col =>
                        col.name.toLowerCase().includes(query) || col.description?.toLowerCase().includes(query)
                    )) ||
                    (item.resource_type === 'model' && (item.raw_code?.toLowerCase().includes(query) || item.compiled_code?.toLowerCase().includes(query)))
                );
            };

            const clearSearch = () => {
                searchQuery.value = '';
                searchResults.value = [];
            };

            const selectSearchResult = (result) => selectItem(result);
            const getDependencies = (item) => (ODBTM.value.parent_map?.[item.unique_id] ?? []).map(depId => allItemsById.value.get(depId)).filter(Boolean);
            const getDependents = (item) => (ODBTM.value.child_map?.[item.unique_id] ?? []).map(depId => allItemsById.value.get(depId)).filter(Boolean);

            const navigateToDependencyId = (depId) => {
                const item = allItemsById.value.get(depId);
                if (item) selectItem(item);
                else console.warn("Could not find item to navigate to by ID:", depId);
            };

            const navigateToDependency = (dep) => {
                if (dep?.unique_id) navigateToDependencyId(dep.unique_id);
                else console.warn("Could not navigate to invalid dependency:", dep);
            };

            const setLineageDepth = (depth) => {
                lineageMaxDepth.value = depth;
                renderTableLineageGraph();
            };

            const buildVisNetworkData = () => {
                const normalizeTableFqn = (value) => {
                    if (typeof value !== 'string') return null;
                    const parts = value.split('.').map(part => part.trim()).filter(Boolean);
                    return parts.length ? parts.join('.').toLowerCase() : null;
                };

                const visNodes = new Map();
                const visEdges = new Map();
                const visitedNodeIds = new Set();
                const visitedTableByFqn = new Map();
                if (!selectedItem.value) return {nodes: [], edges: []};
                const centerNodeId = selectedItem.value.unique_id;

                const getNodeById = (id) => allItemsById.value.get(id) || ODBTM.value.allnodes?.[id];
                const resolveTableFqn = (node) => {
                    if (!node) return null;
                    const parts = [node.database, node.schema, node.name].filter(Boolean);
                    if (parts.length === 0) return null;
                    return normalizeTableFqn(parts.join('.'));
                };
                const addEdge = (from, to, options = {}) => {
                    const edgeId = `${from}->${to}`;
                    if (!visEdges.has(edgeId)) {
                        visEdges.set(edgeId, {
                            from,
                            to,
                            arrows: 'to',
                            ...options
                        });
                    } else {
                        Object.assign(visEdges.get(edgeId), options);
                    }
                };
                const resolveDependencyNodeId = (dep) => {
                    if (!dep) return null;
                    if (dep.model_id && visNodes.has(dep.model_id)) {
                        return dep.model_id;
                    }
                    const depFqn = normalizeTableFqn(dep.table_fqn ?? dep.table_relative_fqn ?? dep.tableFqn);
                    if (depFqn && visitedTableByFqn.has(depFqn)) {
                        return visitedTableByFqn.get(depFqn);
                    }
                    return null;
                };
                const getColumnLineageMap = (node) => {
                    if (!node) return null;
                    if (node.column_lineage && Object.keys(node.column_lineage).length) {
                        return node.column_lineage;
                    }
                    const columns = node.columns;
                    if (!columns || !Object.keys(columns).length) {
                        return null;
                    }
                    const fallbackMap = {};
                    Object.entries(columns).forEach(([columnName, columnInfo]) => {
                        if (!columnInfo) {
                            return;
                        }
                        const dependsOn = Array.isArray(columnInfo.depends_on) ? columnInfo.depends_on : [];
                        const normalizedDependsOn = dependsOn
                            .map(dep => {
                                if (!dep) return null;
                                const column = dep.column ?? dep.name ?? null;
                                const tableFqnRaw = dep.table_fqn ?? dep.tableFqn ?? dep.table ?? null;
                                const tableRelativeFqnRaw = dep.table_relative_fqn ?? dep.tableRelativeFqn ?? null;
                                const normalizedTableFqn = normalizeTableFqn(tableFqnRaw ?? tableRelativeFqnRaw);
                                const modelId = dep.model_id ?? dep.modelId ?? null;
                                if (!column && !normalizedTableFqn && !modelId) {
                                    return null;
                                }
                                return {
                                    column,
                                    column_fqn: dep.column_fqn ?? dep.columnFqn ?? null,
                                    table_fqn: normalizedTableFqn ?? tableFqnRaw ?? null,
                                    table_relative_fqn: tableRelativeFqnRaw ?? null,
                                    model_id: modelId,
                                    type: dep.type ?? null
                                };
                            })
                            .filter(Boolean);
                        const transformations = Array.isArray(columnInfo.transformations)
                            ? columnInfo.transformations
                            : [];
                        fallbackMap[columnName] = {
                            column_fqn: columnInfo.column_fqn ?? columnInfo.columnFqn ?? null,
                            table_fqn: columnInfo.table_fqn ?? columnInfo.tableFqn ?? null,
                            transformations,
                            depends_on: normalizedDependsOn
                        };
                    });
                    return Object.keys(fallbackMap).length ? fallbackMap : null;
                };

                const addColumnLineage = (node) => {
                    const columnLineageMap = getColumnLineageMap(node);
                    if (!columnLineageMap) return;
                    const tableNodeId = node.unique_id;
                    Object.entries(columnLineageMap).forEach(([columnName, columnInfo]) => {
                        const columnNodeId = `col::${tableNodeId}::${columnName}`;
                        if (!visNodes.has(columnNodeId)) {
                            const isCenterNode = tableNodeId === centerNodeId;
                            const columnTitle = `Column: ${columnName}\nTable: ${node.schema ?? '?'} . ${node.name}`;
                            visNodes.set(columnNodeId, {
                                id: columnNodeId,
                                label: columnName,
                                title: columnTitle,
                                group: 'column',
                                shape: 'ellipse',
                                font: {face: 'monospace'},
                                color: isCenterNode ? {
                                    border: '#f59e0b',
                                    background: '#fef3c7',
                                    highlight: {border: '#b45309', background: '#fde68a'}
                                } : {
                                    border: '#6b7280',
                                    background: '#e5e7eb',
                                    highlight: {border: '#374151', background: '#d1d5db'}
                                },
                                margin: 5
                            });
                        }
                        addEdge(tableNodeId, columnNodeId, {
                            arrows: {to: {enabled: false}},
                            dashes: true,
                            color: {color: '#9ca3af'}
                        });
                        const dependencies = Array.isArray(columnInfo?.depends_on) ? columnInfo.depends_on : [];
                        dependencies.forEach(dep => {
                            const parentNodeId = resolveDependencyNodeId(dep);
                            if (!parentNodeId || !visNodes.has(parentNodeId)) return;
                            const parentColumnName = dep?.column ?? dep?.name;
                            if (!parentColumnName) return;
                            const parentNode = getNodeById(parentNodeId);
                            const parentColumnNodeId = `col::${parentNodeId}::${parentColumnName}`;
                            if (!visNodes.has(parentColumnNodeId)) {
                                const isCenterParent = parentNodeId === centerNodeId;
                                const parentColumnTitle = `Column: ${parentColumnName}\nTable: ${parentNode?.schema ?? '?'} . ${parentNode?.name ?? '?'}`;
                                visNodes.set(parentColumnNodeId, {
                                    id: parentColumnNodeId,
                                    label: parentColumnName,
                                    title: parentColumnTitle,
                                    group: 'column',
                                    shape: 'ellipse',
                                    font: {face: 'monospace'},
                                    color: isCenterParent ? {
                                        border: '#f59e0b',
                                        background: '#fef3c7',
                                        highlight: {border: '#b45309', background: '#fde68a'}
                                    } : {
                                        border: '#9ca3af',
                                        background: '#f3f4f6',
                                        highlight: {border: '#6b7280', background: '#e5e7eb'}
                                    },
                                    margin: 5
                                });
                            }
                            addEdge(parentNodeId, parentColumnNodeId, {
                                arrows: {to: {enabled: false}},
                                dashes: true,
                                color: {color: '#d1d5db'}
                            });
                            addEdge(parentColumnNodeId, columnNodeId, {
                                arrows: 'to',
                                color: {color: '#2563eb'},
                                width: 2
                            });
                        });
                    });
                };

                const traverse = (node, depth, isUpstream) => {
                    if (!node || depth > lineageMaxDepth.value) return;
                    const itemId = node.unique_id;
                    visitedNodeIds.add(itemId);
                    if (!visNodes.has(itemId)) {
                        visNodes.set(itemId, {
                            id: itemId,
                            label: `${node?.schema ?? '?'}.${node.name}`,
                            title: `Type: ${node.resource_type}\nID: ${itemId}`,
                            group: node.resource_type,
                        });
                    }
                    const resolvedFqn = resolveTableFqn(node);
                    if (resolvedFqn) {
                        visitedTableByFqn.set(resolvedFqn, itemId);
                        visitedTableByFqn.set(`.${resolvedFqn}`, itemId);
                    }
                    if (depth === lineageMaxDepth.value) return;

                    const relatedNodes = isUpstream ? getDependencies(node) : getDependents(node);
                    relatedNodes.forEach(relatedNode => {
                        if (!relatedNode) return;
                        if (isUpstream) {
                            addEdge(relatedNode.unique_id, itemId);
                        } else {
                            addEdge(itemId, relatedNode.unique_id);
                        }
                        traverse(relatedNode, depth + 1, isUpstream);
                    });
                };

                traverse(selectedItem.value, 0, true);  // Upstream
                traverse(selectedItem.value, 0, false); // Downstream
                visitedNodeIds.forEach(nodeId => {
                    const node = getNodeById(nodeId);
                    addColumnLineage(node);
                });

                if (visNodes.has(centerNodeId)) {
                    const centerNodeData = visNodes.get(centerNodeId);
                    centerNodeData.color = {border: '#e11d48', background: '#fecdd3', highlight: {border: '#be123c', background: '#fda4af'}};
                    centerNodeData.font = {color: '#881337', bold: true};
                    centerNodeData.borderWidth = 2;
                }

                const edgesArray = Array.from(visEdges.values());
                return {nodes: Array.from(visNodes.values()), edges: edgesArray};
            };

            const renderTableLineageGraph = async () => {
                if (!selectedItem.value || !lineageGraphContainer.value) return;
                lineageRendering.value = true;
                lineageError.value = false;
                await nextTick();

                try {
                    const {nodes, edges} = buildVisNetworkData();
                    if (currentVisNetwork) currentVisNetwork.destroy();

                    if (nodes.length === 0) {
                        lineageGraphContainer.value.innerHTML = '<p class="text-center text-gray-500 p-4">No lineage data to display.</p>';
                        return;
                    }

                    currentVisNetwork = new vis.Network(lineageGraphContainer.value, {nodes, edges}, VIS_NETWORK_OPTIONS);
                    currentVisNetwork.on('doubleClick', ({nodes}) => {
                        if (nodes.length === 0) return;
                        const clickedNodeId = nodes[0];
                        if (clickedNodeId === selectedItem.value.unique_id) return;
                        if (clickedNodeId.startsWith('col::')) {
                            const parts = clickedNodeId.split('::');
                            const parentId = parts[1];
                            if (parentId && parentId !== selectedItem.value.unique_id) {
                                navigateToDependencyId(parentId);
                            }
                            return;
                        }
                        navigateToDependencyId(clickedNodeId);
                    });
                    currentVisNetwork.once('stabilizationIterationsDone', () => {
                        if (!isLineageFullScreen.value) {
                            currentVisNetwork.fit({animation: {duration: 500, easingFunction: 'easeInOutQuad'}});
                        }
                    });
                } catch (error) {
                    console.error("Error rendering lineage graph:", error);
                    lineageError.value = true;
                } finally {
                    lineageRendering.value = false;
                }
            };

            const getIconClassForResourceTypeById = (resourceId) => {
                const item = allItemsById.value.get(resourceId);
                return item ? getIconClassForResourceType(item.resource_type, item.language) : 'fas fa-table text-blue-500';
            };

            const getIconClassForResourceType = (resourceType = "model", resourceLanguage = 'sql') => {
                switch (resourceType) {
                    case 'model': return resourceLanguage === "python" ? 'fa-brands fa-python text-yellow-500' : 'fas fa-table text-blue-500';
                    case 'source': return 'fas fa-table text-green-500';
                    case 'macro': return 'fa-solid fa-scroll text-purple-500';
                    case 'test': return 'fa-solid fa-flask-vial text-purple-500';
                    case 'seed': return 'fa-solid fa-file-csv text-gray-500';
                    default: return 'fa-regular fa-circle text-gray-500';
                }
            };

            // --- LIFECYCLE & WATCHERS ---
            onMounted(async () => {
                try {
                    if (typeof window !== 'undefined' && window.localStorage) {
                        const storedKey = window.localStorage.getItem('OPENDBT_OPENAI_KEY');
                        if (storedKey) {
                            aiApiKey.value = storedKey;
                        }
                    }
                } catch (error) {
                    console.warn("Unable to read OPENAI key from localStorage:", error);
                }
                ODBTM.value = await loadDbtFiles();
                isLoading.value = false;
                await nextTick();
                handleUrlHash();
                window.addEventListener('hashchange', handleUrlHash);
                document.addEventListener('fullscreenchange', handleFullScreenChange);
            });

            onUnmounted(() => {
                window.removeEventListener('hashchange', handleUrlHash);
                document.removeEventListener('fullscreenchange', handleFullScreenChange);
            });

            watch(aiApiKey, (newValue) => {
                if (typeof window === 'undefined' || !window.localStorage) return;
                try {
                    if (!newValue) {
                        window.localStorage.removeItem('OPENDBT_OPENAI_KEY');
                    } else {
                        window.localStorage.setItem('OPENDBT_OPENAI_KEY', newValue);
                    }
                } catch (error) {
                    console.warn("Unable to persist OPENAI key to localStorage:", error);
                }
            });

            watch(selectedItem, (item) => {
                if (item) ensureAiSession(item.unique_id);
            });

            watch([activeTab, selectedItem], ([newActiveTab]) => {
                if (['code', 'configuration'].includes(newActiveTab)) {
                    nextTick(() => hljs.highlightAll());
                }
            });

            watch(databaseTree, (newTree) => {
                if (newTree.length > 0 && !window.location.hash && expandedNodes.value.length === 0) {
                    const firstDb = newTree[0];
                    if (firstDb?.schemas.length > 0) {
                        expandedNodes.value.push(firstDb.name, `${firstDb.name}.${firstDb.schemas[0].name}`);
                    }
                }
            });

            return {
                isLoading, ODBTM, databaseTree, expandedNodes, selectedItem, searchQuery, searchResults,
                lineageContainer, lineageGraphContainer, lineageMaxDepth, lineageRendering, lineageError,
                activeTab, displayColumns, selectedItemStats, isLineageFullScreen,
                toggleLineageFullScreen, getModelCode, highlightMatches, performSearch, clearSearch,
                selectItem, selectSearchResult, navigateToDependency, navigateToDependencyId,
                renderTableLineageGraph, getDependencies, getDependents, toggleNode, setLineageDepth,
                getIconClassForResourceType, getIconClassForResourceTypeById, displayDescriptionText,
                aiModel, aiApiKey, activeAiSession, aiDraft, aiHasKey, canSendAiPrompt, sendAiPrompt, resetAiSession
            };
        }
    }).mount('#app');
</script>
</body>
</html>
